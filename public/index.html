<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur Trading Live - Donn√©es R√©elles</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .status {
            display: inline-block;
            padding: 8px 20px;
            background: #27ae60;
            color: white;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-weight: bold;
            color: #34495e;
        }
        
        .metric-value {
            color: #2c3e50;
            font-weight: bold;
        }
        
        .positive {
            color: #27ae60 !important;
        }
        
        .negative {
            color: #e74c3c !important;
        }
        
        .neutral {
            color: #f39c12 !important;
        }
        
        .last-update {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .price-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #27ae60;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analyseur Trading Live</h1>
            <p>Donn√©es r√©elles ‚Ä¢ Calculs automatiques ‚Ä¢ Pr√©dictions AI</p>
            <div class="status" id="connectionStatus">
                <span class="loading"></span>Connexion en cours...
            </div>
        </div>
        
        <div class="main-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title" id="chartTitle">EUR/USD</div>
                    <div class="price-display" id="currentPrice">--</div>
                </div>
                <canvas id="priceChart" width="800" height="400"></canvas>
            </div>
            
            <div class="controls">
                <h3>‚öôÔ∏è Param√®tres de Trading</h3>
                
                <div class="form-group">
                    <label for="symbolSelect">Instrument:</label>
                    <select id="symbolSelect">
                        <option value="EURUSD">EUR/USD (Forex)</option>
                        <option value="XAUUSD">XAU/USD (Gold)</option>
                        <option value="BTCUSD">BTC/USD (Bitcoin)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="balance">Balance ($):</label>
                    <input type="number" id="balance" value="10000" min="100" step="100">
                </div>
                
                <div class="form-group">
                    <label for="riskPercent">Risque (%):</label>
                    <input type="number" id="riskPercent" value="2" min="0.1" max="10" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="stopLoss">Stop Loss (pips):</label>
                    <input type="number" id="stopLoss" value="50" min="5" step="5">
                </div>
                
                <div class="form-group">
                    <label for="riskReward">Ratio R:R:</label>
                    <input type="number" id="riskReward" value="2" min="1" max="5" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="horizon">Horizon (jours):</label>
                    <input type="number" id="horizon" value="7" min="1" max="30" step="1">
                </div>
                
                <button class="btn" onclick="recalculate()">
                    üîÑ Recalculer
                </button>
            </div>
        </div>
        
        <div class="results-grid">
            <div class="result-card">
                <h3>üìà Analyse Technique</h3>
                <div id="technicalAnalysis">
                    <div class="metric">
                        <span class="metric-label">Prix actuel:</span>
                        <span class="metric-value" id="techCurrentPrice">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ATR:</span>
                        <span class="metric-value" id="atr">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">SMA 20:</span>
                        <span class="metric-value" id="sma20">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">SMA 50:</span>
                        <span class="metric-value" id="sma50">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RSI:</span>
                        <span class="metric-value" id="rsi">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Tendance:</span>
                        <span class="metric-value" id="trend">--</span>
                    </div>
                </div>
            </div>
            
            <div class="result-card">
                <h3>üí∞ Gestion du Risque</h3>
                <div id="riskManagement">
                    <div class="metric">
                        <span class="metric-label">Stop Loss:</span>
                        <span class="metric-value negative" id="slPrice">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Take Profit:</span>
                        <span class="metric-value positive" id="tpPrice">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Taille Position:</span>
                        <span class="metric-value" id="positionSize">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lots:</span>
                        <span class="metric-value" id="lots">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Risque ($):</span>
                        <span class="metric-value negative" id="riskAmount">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ratio R:R r√©el:</span>
                        <span class="metric-value" id="actualRR">--</span>
                    </div>
                </div>
            </div>
            
            <div class="result-card">
                <h3>üìä Profit/Perte Potentiel</h3>
                <div id="profitLoss">
                    <div class="metric">
                        <span class="metric-label">Profit Potentiel:</span>
                        <span class="metric-value positive" id="potentialProfit">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Perte Potentielle:</span>
                        <span class="metric-value negative" id="potentialLoss">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ROI Potentiel:</span>
                        <span class="metric-value" id="roi">--</span>
                    </div>
                </div>
            </div>
            
            <div class="result-card">
                <h3>üîÆ Pr√©dictions IA</h3>
                <div id="predictions">
                    <div class="metric">
                        <span class="metric-label">Sc√©nario Neutre:</span>
                        <span class="metric-value neutral" id="predNeutral">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Sc√©nario Haussier:</span>
                        <span class="metric-value positive" id="predBullish">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Sc√©nario Baissier:</span>
                        <span class="metric-value negative" id="predBearish">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Probabilit√©:</span>
                        <span class="metric-value" id="probability">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Horizon:</span>
                        <span class="metric-value" id="predHorizon">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="last-update" id="lastUpdate">
            Derni√®re mise √† jour: --
        </div>
    </div>
    
    <script>
        // Variables globales
        let chart;
        let currentSymbol = 'EURUSD';
        let updateInterval;
        let lastUpdateTime = 0;
        
        // Configuration du graphique
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Prix de cl√¥ture',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'SMA 20',
                        data: [],
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'SMA 50',
                        data: [],
                        borderColor: '#f39c12',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Temps'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Prix'
                            },
                            position: 'right'
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(currentSymbol === 'BTCUSD' ? 0 : 5);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Mise √† jour du graphique
        function updateChart(priceData) {
            if (!chart) return;
            
            const prices = priceData.prices.map(p => ({
                x: new Date(p.timestamp),
                y: p.close
            }));
            
            chart.data.datasets[0].data = prices;
            
            // Ajouter les moyennes mobiles si disponibles
            if (priceData.sma20 && priceData.sma50) {
                const lastTime = new Date(priceData.prices[priceData.prices.length - 1].timestamp);
                chart.data.datasets[1].data = [{x: lastTime, y: priceData.sma20}];
                chart.data.datasets[2].data = [{x: lastTime, y: priceData.sma50}];
            }
            
            chart.update('none');
        }
        
        // R√©cup√©ration des donn√©es de prix
        async function fetchPriceData() {
            try {
                const response = await fetch(`/api/prices/${currentSymbol}`);
                if (!response.ok) throw new Error('Erreur r√©seau');
                
                const data = await response.json();
                
                // Mise √† jour du graphique
                updateChart(data);
                
                // Mise √† jour des informations techniques
                document.getElementById('currentPrice').textContent = formatPrice(data.currentPrice);
                document.getElementById('chartTitle').textContent = formatSymbolName(currentSymbol);
                document.getElementById('techCurrentPrice').textContent = formatPrice(data.currentPrice);
                document.getElementById('atr').textContent = formatPrice(data.atr);
                document.getElementById('sma20').textContent = formatPrice(data.sma20);
                document.getElementById('sma50').textContent = formatPrice(data.sma50);
                document.getElementById('rsi').textContent = data.rsi.toFixed(1);
                
                // Couleur de la tendance
                const trendElement = document.getElementById('trend');
                trendElement.textContent = data.trend;
                trendElement.className = 'metric-value ' + (data.trend === 'Bullish' ? 'positive' : 'negative');
                
                // Mise √† jour du statut
                document.getElementById('connectionStatus').innerHTML = 'üü¢ Donn√©es en temps r√©el';
                document.getElementById('connectionStatus').style.background = '#27ae60';
                
                lastUpdateTime = Date.now();
                
                return data;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es:', error);
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Erreur de connexion';
                document.getElementById('connectionStatus').style.background = '#e74c3c';
                return null;
            }
        }
        
        // Calculs de trading
        async function calculateTrading() {
            const params = {
                symbol: currentSymbol,
                balance: parseFloat(document.getElementById('balance').value),
                riskPercent: parseFloat(document.getElementById('riskPercent').value),
                stopLossPips: parseFloat(document.getElementById('stopLoss').value),
                horizonDays: parseInt(document.getElementById('horizon').value),
                riskRewardRatio: parseFloat(document.getElementById('riskReward').value)
            };
            
            try {
                const response = await fetch('/api/calc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                if (!response.ok) throw new Error('Erreur de calcul');
                
                const data = await response.json();
                
                // Mise √† jour de la gestion du risque
                document.getElementById('slPrice').textContent = formatPrice(data.stopLossPrice);
                document.getElementById('tpPrice').textContent = formatPrice(data.takeProfitPrice);
                document.getElementById('positionSize').textContent = data.positionSize.toLocaleString();
                document.getElementById('lots').textContent = data.lots;
                document.getElementById('riskAmount').textContent = ' + data.riskAmount;
                document.getElementById('actualRR').textContent = data.riskRewardRatio;
                
                // Mise √† jour des profits/pertes
                document.getElementById('potentialProfit').textContent = ' + data.potentialProfit;
                document.getElementById('potentialLoss').textContent = ' + data.potentialLoss;
                
                const roi = (parseFloat(data.potentialProfit) / params.balance * 100).toFixed(2);
                document.getElementById('roi').textContent = roi + '%';
                
                // Mise √† jour des pr√©dictions
                document.getElementById('predNeutral').textContent = formatPrice(data.predictions.neutral);
                document.getElementById('predBullish').textContent = formatPrice(data.predictions.bullish);
                document.getElementById('predBearish').textContent = formatPrice(data.predictions.bearish);
                document.getElementById('probability').textContent = data.predictions.probability + '%';
                document.getElementById('predHorizon').textContent = data.predictions.horizon + ' jours';
                
            } catch (error) {
                console.error('Erreur lors du calcul:', error);
                alert('Erreur lors du calcul des param√®tres de trading');
            }
        }
        
        // Formatage des prix
        function formatPrice(price) {
            const decimals = currentSymbol === 'BTCUSD' ? 0 : 5;
            return parseFloat(price).toFixed(decimals);
        }
        
        // Formatage du nom du symbole
        function formatSymbolName(symbol) {
            const names = {
                'EURUSD': 'EUR/USD',
                'XAUUSD': 'XAU/USD (Gold)',
                'BTCUSD': 'BTC/USD (Bitcoin)'
            };
            return names[symbol] || symbol;
        }
        
        // Recalcul manuel
        function recalculate() {
            calculateTrading();
        }
        
        // Mise √† jour automatique
        async function updateAll() {
            console.log(`\nüîÑ [FRONT] ========== MISE √Ä JOUR GLOBALE ==========`);
            console.log(`üîÑ [FRONT] D√©but de la mise √† jour pour ${currentSymbol}`);
            
            const startTime = Date.now();
            
            try {
                // R√©cup√©ration des donn√©es de prix
                const priceData = await fetchPriceData();
                if (!priceData) {
                    console.log(`‚ùå [FRONT] √âchec de r√©cup√©ration des donn√©es`);
                    return;
                }
                
                // Calcul des param√®tres de trading
                await calculateTrading();
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // Mise √† jour du timestamp
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `Derni√®re mise √† jour: ${now.toLocaleTimeString()} (${duration}ms)`;
                
                console.log(`‚úÖ [FRONT] Mise √† jour termin√©e en ${duration}ms`);
                console.log(`üîÑ [FRONT] =======================================\n`);
                
            } catch (error) {
                console.error('‚ùå [FRONT] Erreur lors de la mise √† jour globale:', error);
                
                // Affichage d'erreur dans l'interface
                document.getElementById('lastUpdate').textContent = 
                    `Erreur lors de la mise √† jour: ${new Date().toLocaleTimeString()}`;
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Erreur syst√®me';
                document.getElementById('connectionStatus').style.background = '#e74c3c';
            }
        }
        
        // Changement d'instrument
        document.getElementById('symbolSelect').addEventListener('change', function() {
            const oldSymbol = currentSymbol;
            currentSymbol = this.value;
            console.log(`üîÑ [FRONT] Changement d'instrument: ${oldSymbol} ‚Üí ${currentSymbol}`);
            updateAll();
        });
        
        // Mise √† jour automatique des param√®tres avec debounce
        ['balance', 'riskPercent', 'stopLoss', 'riskReward', 'horizon'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                console.log(`‚öôÔ∏è [FRONT] Param√®tre modifi√©: ${id} = ${this.value}`);
                
                // D√©bounce pour √©viter trop d'appels
                clearTimeout(this.timeout);
                this.timeout = setTimeout(() => {
                    console.log(`üîÑ [FRONT] Recalcul automatique d√©clench√© par ${id}`);
                    calculateTrading();
                }, 500);
            });
        });
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`üöÄ [FRONT] ========== INITIALISATION ==========`);
            console.log(`üöÄ [FRONT] DOM charg√©, d√©marrage de l'application`);
            
            initChart();
            console.log(`üìä [FRONT] Graphique initialis√©`);
            
            updateAll();
            console.log(`üîÑ [FRONT] Premi√®re mise √† jour lanc√©e`);
            
            // Mise √† jour automatique toutes les 30 secondes
            updateInterval = setInterval(() => {
                console.log(`‚è∞ [FRONT] Mise √† jour automatique programm√©e`);
                updateAll();
            }, 30000);
            
            console.log(`‚è∞ [FRONT] Timer de mise √† jour configur√© (30s)`);
            console.log(`üöÄ [FRONT] ========================================`);
        });
        
        // Nettoyage √† la fermeture
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
