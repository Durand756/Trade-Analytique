<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Trade Analyzer</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1724; --muted:#9aa4b2; --accent:#4fd1c5;
      --card-radius:14px;
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:var(--bg);color:#e6eef6;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:20px;}
    .container{width:100%;max-width:1100px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    h1{font-size:20px;margin:0;}
    .controls{display:flex;gap:8px;align-items:center;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:12px;}
    canvas{width:100%;height:360px;background:transparent;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
    input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:14px;}
    button{cursor:pointer;background:var(--accent);color:#002; border:none;padding:10px 12px;border-radius:10px;}
    table{width:100%;border-collapse:collapse;margin-top:8px;}
    td,th{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;}
    .muted{color:var(--muted);font-size:12px;}
    .small{font-size:13px;}
    .toggle{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;}
    @media(max-width:900px){ .layout{grid-template-columns:1fr; } canvas{height:300px} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Live Trade Analyzer</h1>
        <div class="muted">Graph live · SL/TP · position sizing · prévisions</div>
      </div>
      <div class="controls">
        <button id="refreshBtn" class="toggle">Refresh</button>
        <button id="themeBtn" class="toggle">Toggle theme</button>
      </div>
    </header>

    <div class="card layout">
      <div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;">
          <div>
            <label for="symbolSelect">Symbol</label>
            <select id="symbolSelect">
              <option value="EURUSD">EUR/USD</option>
              <option value="XAUUSD">XAU/USD</option>
              <option value="BTCUSD">BTC/USD</option>
            </select>
          </div>
          <div>
            <label for="intervalSelect">Interval</label>
            <select id="intervalSelect">
              <option value="1min">1m</option>
              <option value="5min">5m</option>
              <option value="15min">15m</option>
            </select>
          </div>
          <div style="margin-left:auto;">
            <label class="muted">Last update</label>
            <div id="lastUpdate" class="muted small">-</div>
          </div>
        </div>

        <canvas id="priceChart"></canvas>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;">
          <div style="min-width:220px;">
            <label>Balance (USD)</label>
            <input id="balance" type="number" value="1000" />
          </div>
          <div style="min-width:140px;">
            <label>Risk %</label>
            <input id="risk" type="number" value="1" step="0.1" />
          </div>
          <div style="min-width:140px;">
            <label>Stop Loss (pips) — empty = auto</label>
            <input id="slPips" type="number" placeholder="auto" />
          </div>
          <div style="min-width:140px;">
            <label>RR ratio</label>
            <input id="rr" type="number" value="2" step="0.1" />
          </div>
          <div style="min-width:140px;">
            <label>Horizon (minutes)</label>
            <input id="horizon" type="number" value="60" />
          </div>
          <div style="align-self:end;">
            <button id="recalcBtn">Recalculate</button>
          </div>
        </div>

        <div id="results" style="margin-top:12px;">
          <table>
            <tbody id="resultsBody">
              <tr><th>Item</th><th>Value</th></tr>
            </tbody>
          </table>
        </div>

      </div>

      <aside>
        <div class="card" style="padding:12px;">
          <h3 style="margin:0 0 8px 0;">Quick stats</h3>
          <div id="quickStats" class="muted small">—</div>

          <h3 style="margin-top:12px;">Notes</h3>
          <div class="muted small">
            • Default calculations use ATR-derived SL if SL not provided.<br/>
            • Position sizing assumes quote currency = USD and standard lot = 100,000 units.<br/>
            • Set API keys as env vars (TWELVEDATA_KEY, ALPHAVANTAGE_KEY) on Render or locally.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // English variable names (user preference)
    const symbolSelect = document.getElementById('symbolSelect');
    const intervalSelect = document.getElementById('intervalSelect');
    const balanceInput = document.getElementById('balance');
    const riskInput = document.getElementById('risk');
    const slPipsInput = document.getElementById('slPips');
    const rrInput = document.getElementById('rr');
    const horizonInput = document.getElementById('horizon');
    const recalcBtn = document.getElementById('recalcBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const themeBtn = document.getElementById('themeBtn');
    const resultsBody = document.getElementById('resultsBody');
    const quickStats = document.getElementById('quickStats');
    const lastUpdate = document.getElementById('lastUpdate');

    let chart;
    let cachedCandles = [];
    let pollInterval = 10_000; // 10s

    function humanTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    async function fetchPrices(symbol) {
      const resp = await fetch(`/api/prices/${symbol}`);
      const j = await resp.json();
      if (!j.ok) throw new Error(j.error || 'no data');
      return j;
    }

    function buildChart() {
      const ctx = document.getElementById('priceChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Price',
            data: [],
            borderWidth: 1,
            pointRadius: 0,
            tension: 0.15
          }]
        },
        options: {
          animation: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } },
            y: { beginAtZero: false }
          }
        }
      });
    }

    function updateChart(candles) {
      const labels = candles.map(c => new Date(c.t));
      const data = candles.map(c => c.close);
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }

    async function recalc() {
      try {
        const symbol = symbolSelect.value;
        const balance = parseFloat(balanceInput.value || '1000');
        const riskPercent = parseFloat(riskInput.value || '1');
        const stopLossPips = slPipsInput.value ? parseFloat(slPipsInput.value) : null;
        const rr = parseFloat(rrInput.value || '2');
        const horizonMinutes = parseInt(horizonInput.value || '60', 10);

        // get last price (we already have candles cached)
        const last = cachedCandles[cachedCandles.length - 1];
        const entryPrice = last.close;

        const body = { symbol, balance, riskPercent, rr, horizonMinutes };
        if (stopLossPips) body.stopLossPips = stopLossPips;
        body.entryPrice = entryPrice;

        const resp = await fetch('/api/calc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await resp.json();
        if (!j.ok) throw new Error(j.error || 'calc failed');

        // render results
        resultsBody.innerHTML = `
          <tr><th>Item</th><th>Value</th></tr>
          <tr><td>Symbol</td><td>${j.symbol}</td></tr>
          <tr><td>Entry price</td><td>${j.entryPrice.toFixed(6)}</td></tr>
          <tr><td>Last price</td><td>${j.lastPrice.toFixed(6)}</td></tr>
          <tr><td>ATR</td><td>${j.atr ? j.atr.toFixed(6) : '-'}</td></tr>
          <tr><td>Stop loss (pips)</td><td>${j.stopLossPips}</td></tr>
          <tr><td>Stop loss (price)</td><td>${j.stopLossPriceMove.toFixed(6)}</td></tr>
          <tr><td>R:R</td><td>${j.rr}</td></tr>
          <tr><td>SL (long)</td><td>${j.slLong.toFixed(6)}</td></tr>
          <tr><td>TP (long)</td><td>${j.tpLong.toFixed(6)}</td></tr>
          <tr><td>Units (base)</td><td>${Math.round(j.units)}</td></tr>
          <tr><td>Lots (std)</td><td>${(j.lots).toFixed(4)}</td></tr>
          <tr><td>Forecast (h=${j.forecast.horizonMinutes}m)</td><td>expect ${j.forecast.expected.toFixed(6)} (95% CI ${j.forecast.conf95_low.toFixed(6)} — ${j.forecast.conf95_high.toFixed(6)})</td></tr>
        `;
        quickStats.innerHTML = `
          Last price: ${j.lastPrice.toFixed(6)} <br/>
          Risk amount: ${j.riskAmount.toFixed(2)} USD <br/>
          Pip size: ${j.pipSize}
        `;
      } catch (e) {
        console.error(e);
        alert('Erreur lors du calcul: ' + (e.message || e));
      }
    }

    async function refreshData() {
      try {
        const symbol = symbolSelect.value;
        const j = await fetchPrices(symbol);
        cachedCandles = j.candles;
        updateChart(cachedCandles);
        lastUpdate.textContent = humanTime(cachedCandles[cachedCandles.length - 1].t);
      } catch (e) {
        console.error(e);
      }
    }

    // initial
    (function init() {
      buildChart();
      refreshData().then(recalc).catch(console.error);

      // poll
      setInterval(async () => {
        await refreshData();
      }, pollInterval);

      // event handlers
      recalcBtn.onclick = recalc;
      symbolSelect.onchange = async () => { await refreshData(); recalc(); };
      intervalSelect.onchange = async () => { await refreshData(); recalc(); };
      refreshBtn.onclick = async () => { await refreshData(); recalc(); };

      // theme toggle - simple (persist)
      const themeStored = localStorage.getItem('theme') || 'dark';
      if (themeStored === 'light') document.body.style.background = '#f7fafc', document.body.style.color = '#0b1220';
      themeBtn.onclick = () => {
        const cur = localStorage.getItem('theme') || 'dark';
        if (cur === 'dark') {
          localStorage.setItem('theme','light');
          document.body.style.background = '#f7fafc';
          document.body.style.color = '#0b1220';
        } else {
          localStorage.setItem('theme','dark');
          document.body.style.background = '';
          document.body.style.color = '';
        }
      };
    })();
  </script>
</body>
</html>
