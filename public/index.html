<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Analyseur de Trading Live - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/3.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .trading-dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .controls-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .symbol-selector {
            margin-bottom: 20px;
        }
        
        .symbol-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .symbol-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .symbol-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .symbol-btn.active {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }
        
        .price-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .current-price {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }
        
        .price-change {
            font-size: 1.2em;
            margin-top: 5px;
        }
        
        .price-change.positive { color: #00ff88; }
        .price-change.negative { color: #ff4444; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
        }
        
        .form-group input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .calc-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.4);
        }
        
        .results-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-top: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .result-title {
            color: #FFD700;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .result-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #00ff88;
        }
        
        .analysis-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .indicator-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        
        .signal-lights {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .signal-light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
        }
        
        .signal-buy {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: white;
        }
        
        .signal-sell {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }
        
        .signal-neutral {
            background: linear-gradient(45deg, #888, #666);
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            margin-top: 20px;
        }
        
        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .status-online {
            color: #00ff88;
        }
        
        .status-offline {
            color: #ff4444;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            opacity: 0.8;
        }
        
        .fibonacci-levels {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .fib-level {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .trading-dashboard {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .symbol-buttons {
                flex-direction: column;
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Analyseur de Trading Live</h1>
            <p>Analyse technique en temps r√©el avec donn√©es de march√© authentiques</p>
        </div>
        
        <div class="trading-dashboard">
            <div class="chart-section">
                <div class="symbol-buttons">
                    <button class="symbol-btn active" onclick="selectSymbol('EUR-USD')">EUR/USD</button>
                    <button class="symbol-btn" onclick="selectSymbol('XAU-USD')">XAU/USD</button>
                    <button class="symbol-btn" onclick="selectSymbol('BTC-USD')">BTC/USD</button>
                </div>
                
                <div class="price-display">
                    <div class="current-price" id="currentPrice">Loading...</div>
                    <div class="price-change" id="priceChange">--</div>
                    <div style="font-size: 0.8em; margin-top: 5px;" id="lastUpdate">--</div>
                </div>
                
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
            
            <div class="controls-section">
                <h3>‚öôÔ∏è Param√®tres de Trading</h3>
                
                <div class="form-group">
                    <label for="balance">Balance du compte ($)</label>
                    <input type="number" id="balance" value="10000" placeholder="10000">
                </div>
                
                <div class="form-group">
                    <label for="riskPercent">Risque par trade (%)</label>
                    <input type="number" id="riskPercent" value="2" step="0.1" placeholder="2.0">
                </div>
                
                <div class="form-group">
                    <label for="stopLossPips">Stop Loss (pips)</label>
                    <input type="number" id="stopLossPips" value="20" placeholder="20">
                </div>
                
                <div class="form-group">
                    <label for="takeProfitRatio">Ratio Take Profit</label>
                    <input type="number" id="takeProfitRatio" value="2" step="0.1" placeholder="2.0">
                </div>
                
                <div class="form-group">
                    <label for="timeHorizon">Horizon temporel (jours)</label>
                    <input type="number" id="timeHorizon" value="7" placeholder="7">
                </div>
                
                <button class="calc-btn" onclick="calculatePositioning()">
                    üîÑ Recalculer en Direct
                </button>
                
                <div class="signal-lights">
                    <div class="signal-light signal-neutral" id="buySignal">
                        NEUTRE
                    </div>
                    <div class="signal-light signal-neutral" id="sellSignal">
                        NEUTRE
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-section">
            <h3>üìä R√©sultats de l'Analyse</h3>
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-title">Taille de Position</div>
                    <div class="result-value" id="positionSize">--</div>
                </div>
                <div class="result-card">
                    <div class="result-title">Montant Risqu√©</div>
                    <div class="result-value" id="riskAmount">--</div>
                </div>
                <div class="result-card">
                    <div class="result-title">Stop Loss</div>
                    <div class="result-value" id="stopLossLevel">--</div>
                </div>
                <div class="result-card">
                    <div class="result-title">Take Profit</div>
                    <div class="result-value" id="takeProfitLevel">--</div>
                </div>
                <div class="result-card">
                    <div class="result-title">Prix Pr√©dit</div>
                    <div class="result-value" id="predictedPrice">--</div>
                </div>
                <div class="result-card">
                    <div class="result-title">Probabilit√© de Succ√®s</div>
                    <div class="result-value" id="successProb">--</div>
                </div>
            </div>
            
            <div class="analysis-section">
                <h4>üîç Indicateurs Techniques</h4>
                <div class="indicator-row">
                    <span>ATR (Volatilit√©):</span>
                    <span id="atrValue">--</span>
                </div>
                <div class="indicator-row">
                    <span>RSI:</span>
                    <span id="rsiValue">--</span>
                </div>
                <div class="indicator-row">
                    <span>Volatilit√© Annuelle:</span>
                    <span id="volatilityValue">--</span>
                </div>
                <div class="indicator-row">
                    <span>Force de Tendance:</span>
                    <span id="trendStrength">--</span>
                </div>
                <div class="indicator-row">
                    <span>MACD:</span>
                    <span id="macdValue">--</span>
                </div>
                
                <div class="fibonacci-levels">
                    <h5>üìà Niveaux de Fibonacci</h5>
                    <div id="fibonacciLevels">
                        <div class="fib-level">
                            <span>0% (R√©sistance):</span>
                            <span id="fib0">--</span>
                        </div>
                        <div class="fib-level">
                            <span>23.6%:</span>
                            <span id="fib236">--</span>
                        </div>
                        <div class="fib-level">
                            <span>38.2%:</span>
                            <span id="fib382">--</span>
                        </div>
                        <div class="fib-level">
                            <span>50%:</span>
                            <span id="fib50">--</span>
                        </div>
                        <div class="fib-level">
                            <span>61.8%:</span>
                            <span id="fib618">--</span>
                        </div>
                        <div class="fib-level">
                            <span>100% (Support):</span>
                            <span id="fib100">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <span id="connectionStatus" class="status-online">üü¢ Connect√© - Donn√©es Live</span>
    </div>
    
    <script>
        // Variables globales
        let currentSymbol = 'EUR-USD';
        let priceChart = null;
        let updateInterval = null;
        let lastPrice = 0;
        let chartData = [];
        
        // Configuration du graphique
        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'Bollinger Sup√©rieure',
                        data: [],
                        borderColor: '#FFD700',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }, {
                        label: 'Bollinger Inf√©rieure',
                        data: [],
                        borderColor: '#FFD700',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // S√©lection de symbole
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            
            // Mise √† jour de l'interface
            document.querySelectorAll('.symbol-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // R√©initialisation des donn√©es
            chartData = [];
            if (priceChart) {
                priceChart.data.labels = [];
                priceChart.data.datasets[0].data = [];
                priceChart.data.datasets[1].data = [];
                priceChart.data.datasets[2].data = [];
                priceChart.update();
            }
            
            // Chargement imm√©diat des nouvelles donn√©es
            updatePriceData();
        }
        
        // Mise √† jour des donn√©es de prix
        async function updatePriceData() {
            try {
                const response = await fetch(`/api/prices/${currentSymbol}`);
                const data = await response.json();
                
                if (data.currentPrice) {
                    // Mise √† jour du prix affich√©
                    const priceElement = document.getElementById('currentPrice');
                    const changeElement = document.getElementById('priceChange');
                    const updateElement = document.getElementById('lastUpdate');
                    
                    const currentPrice = data.currentPrice;
                    const change = currentPrice - lastPrice;
                    const changePercent = lastPrice > 0 ? ((change / lastPrice) * 100) : 0;
                    
                    priceElement.textContent = formatPrice(currentPrice, currentSymbol);
                    
                    if (change !== 0) {
                        const changeText = `${change >= 0 ? '+' : ''}${formatPrice(change, currentSymbol)} (${changePercent.toFixed(2)}%)`;
                        changeElement.textContent = changeText;
                        changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
                        
                        // Animation de pulsation pour les changements
                        priceElement.classList.add('pulse');
                        setTimeout(() => priceElement.classList.remove('pulse'), 1000);
                    }
                    
                    updateElement.textContent = `Mis √† jour: ${new Date().toLocaleTimeString()}`;
                    lastPrice = currentPrice;
                    
                    // Mise √† jour du graphique
                    if (data.history && data.history.length > 0) {
                        updateChart(data.history, currentPrice);
                    }
                    
                    // Calcul automatique
                    await calculatePositioning();
                    
                    // Statut de connexion
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Connect√© - Donn√©es Live';
                    document.getElementById('connectionStatus').className = 'status-online';
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es:', error);
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Erreur de connexion';
                document.getElementById('connectionStatus').className = 'status-offline';
            }
        }
        
        // Mise √† jour du graphique
        function updateChart(history, currentPrice) {
            if (!priceChart) return;
            
            const labels = history.map(h => new Date(h.time));
            const prices = history.map(h => h.close);
            
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = prices;
            
            // Ajout du point actuel si diff√©rent du dernier point d'historique
            if (history.length > 0) {
                const lastHistoryPrice = history[history.length - 1].close;
                if (Math.abs(currentPrice - lastHistoryPrice) > 0.00001) {
                    priceChart.data.labels.push(new Date());
                    priceChart.data.datasets[0].data.push(currentPrice);
                }
            }
            
            priceChart.update('none'); // Animation d√©sactiv√©e pour de meilleures performances
        }
        
        // Formatage des prix selon le symbole
        function formatPrice(price, symbol) {
            if (symbol === 'BTC-USD') {
                return `${price.toFixed(0)}`;
            } else if (symbol === 'XAU-USD') {
                return `${price.toFixed(2)}`;
            } else {
                return price.toFixed(5);
            }
        }
        
        // Calcul du positionnement et analyse
        async function calculatePositioning() {
            try {
                const balance = parseFloat(document.getElementById('balance').value) || 10000;
                const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 2;
                const stopLossPips = parseFloat(document.getElementById('stopLossPips').value) || 20;
                const takeProfitRatio = parseFloat(document.getElementById('takeProfitRatio').value) || 2;
                const timeHorizon = parseFloat(document.getElementById('timeHorizon').value) || 7;
                
                const requestData = {
                    symbol: currentSymbol,
                    balance,
                    riskPercent,
                    stopLossPips,
                    takeProfitRatio,
                    timeHorizon,
                    currentPrice: lastPrice
                };
                
                const response = await fetch('/api/calc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.position) {
                    // Mise √† jour des r√©sultats
                    document.getElementById('positionSize').textContent = result.position.size.toFixed(2);
                    document.getElementById('riskAmount').textContent = `${result.position.riskAmount.toFixed(2)}`;
                    document.getElementById('stopLossLevel').textContent = formatPrice(result.position.stopLoss, currentSymbol);
                    document.getElementById('takeProfitLevel').textContent = formatPrice(result.position.takeProfit, currentSymbol);
                    document.getElementById('predictedPrice').textContent = formatPrice(result.prediction.targetPrice, currentSymbol);
                    document.getElementById('successProb').textContent = `${result.prediction.successProbability}%`;
                    
                    // Mise √† jour des indicateurs techniques
                    document.getElementById('atrValue').textContent = result.analysis.atr;
                    document.getElementById('rsiValue').textContent = `${result.analysis.rsi} ${getRSISignal(result.analysis.rsi)}`;
                    document.getElementById('volatilityValue').textContent = `${result.analysis.volatility}%`;
                    document.getElementById('trendStrength').textContent = `${(result.analysis.trendStrength * 100).toFixed(0)}%`;
                    document.getElementById('macdValue').textContent = `${result.analysis.macd.macd.toFixed(5)}`;
                    
                    // Mise √† jour des niveaux de Fibonacci
                    const fib = result.analysis.fibonacciLevels;
                    document.getElementById('fib0').textContent = formatPrice(fib['0%'], currentSymbol);
                    document.getElementById('fib236').textContent = formatPrice(fib['23.6%'], currentSymbol);
                    document.getElementById('fib382').textContent = formatPrice(fib['38.2%'], currentSymbol);
                    document.getElementById('fib50').textContent = formatPrice(fib['50%'], currentSymbol);
                    document.getElementById('fib618').textContent = formatPrice(fib['61.8%'], currentSymbol);
                    document.getElementById('fib100').textContent = formatPrice(fib['100%'], currentSymbol);
                    
                    // Mise √† jour des signaux de trading
                    updateTradingSignals(result.signals);
                    
                    // Mise √† jour des bandes de Bollinger sur le graphique
                    if (priceChart && result.analysis.bollinger) {
                        const currentTime = new Date();
                        priceChart.data.datasets[1].data.push(result.analysis.bollinger.upper);
                        priceChart.data.datasets[2].data.push(result.analysis.bollinger.lower);
                        priceChart.update('none');
                    }
                }
                
            } catch (error) {
                console.error('Erreur lors du calcul:', error);
            }
        }
        
        // Interpr√©tation du RSI
        function getRSISignal(rsi) {
            if (rsi > 70) return 'üìà Surachat';
            if (rsi < 30) return 'üìâ Survente';
            return '‚öñÔ∏è Neutre';
        }
        
        // Mise √† jour des signaux de trading
        function updateTradingSignals(signals) {
            const buySignal = document.getElementById('buySignal');
            const sellSignal = document.getElementById('sellSignal');
            
            // Signal d'achat
            if (signals.buy) {
                buySignal.className = 'signal-light signal-buy';
                buySignal.textContent = 'BUY';
            } else {
                buySignal.className = 'signal-light signal-neutral';
                buySignal.textContent = 'NEUTRE';
            }
            
            // Signal de vente
            if (signals.sell) {
                sellSignal.className = 'signal-light signal-sell';
                sellSignal.textContent = 'SELL';
            } else {
                sellSignal.className = 'signal-light signal-neutral';
                sellSignal.textContent = 'NEUTRE';
            }
        }
        
        // Initialisation de l'application
        function initializeApp() {
            console.log('üöÄ Initialisation de l\'analyseur de trading...');
            
            // Initialisation du graphique
            initializeChart();
            
            // Premier chargement des donn√©es
            updatePriceData();
            
            // Mise √† jour automatique toutes les 30 secondes
            updateInterval = setInterval(updatePriceData, 30000);
            
            console.log('‚úÖ Application initialis√©e avec succ√®s');
        }
        
        // Gestion de l'arr√™t de l'application
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
        
        // D√©marrage de l'application
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Recalcul automatique lors de la modification des param√®tres
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', () => {
                setTimeout(calculatePositioning, 500); // D√©lai pour √©viter les appels trop fr√©quents
            });
        });
    </script>
</body>
</html>
