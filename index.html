<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Technique Temps Réel - Trading Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .trading-card {
            transition: all 0.3s ease;
            border-left: 4px solid #3273dc;
        } 
        
        .signal-buy { border-left-color: #48c774 !important; }
        .signal-sell { border-left-color: #f14668 !important; }
        .signal-neutral { border-left-color: #b5b5b5 !important; }
        
        .indicator-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .risk-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .blinking { animation: blink 2s linear infinite; }
        @keyframes blink { 0%,50% { opacity: 1; } 51%,100% { opacity: 0.3; } }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online { background-color: #48c774; }
        .status-offline { background-color: #f14668; }
        
        .disclaimer {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }
        
        .timeframe-selector {
            margin-bottom: 1rem;
        }
        
        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container is-fluid">
        <!-- Header -->
        <section class="hero is-primary is-small">
            <div class="hero-body">
                <div class="container">
                    <h1 class="title">
                        <i class="fas fa-chart-line"></i>
                        Analyse Technique Temps Réel
                    </h1>
                    <h2 class="subtitle">
                        Dashboard de Trading avec Prédictions IA
                        <span class="status-indicator status-online" id="statusIndicator"></span>
                        <span id="connectionStatus">En ligne</span>
                    </h2>
                </div>
            </div>
        </section>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <p class="has-text-weight-bold">
                <i class="fas fa-exclamation-triangle"></i>
                AVERTISSEMENT : À titre éducatif seulement. Les marchés financiers sont risqués. 
                Je ne suis pas un conseiller financier. Tradez à vos propres risques.
            </p>
        </div>

        <!-- Controls -->
        <div class="box">
            <div class="columns">
                <div class="column is-4">
                    <div class="field">
                        <label class="label">Actif à analyser</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="assetSelector">
                                    <option value="EUR/USD">EUR/USD</option>
                                    <option value="XAU/USD">XAU/USD (Or)</option>
                                    <option value="BTC/USD">BTC/USD</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column is-4">
                    <div class="field">
                        <label class="label">Timeframe de prédiction</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="timeframeSelector">
                                    <option value="1m">1 Minute</option>
                                    <option value="5m">5 Minutes</option>
                                    <option value="15m">15 Minutes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column is-4">
                    <div class="field">
                        <label class="label">Actions</label>
                        <div class="control">
                            <button class="button is-info" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                            <button class="button is-link" id="riskCalcBtn">
                                <i class="fas fa-calculator"></i> Calc. Risque
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="columns">
            <!-- Chart Section -->
            <div class="column is-8">
                <div class="box">
                    <h3 class="title is-4">
                        <span id="chartTitle">EUR/USD</span>
                        <span class="tag is-info" id="lastUpdateTime">--:--</span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
                
                <!-- Predictions Grid -->
                <div class="box prediction-card">
                    <h4 class="title is-5">🔮 Prédictions Multi-Timeframes</h4>
                    <div class="prediction-grid" id="predictionsGrid">
                        <!-- Predictions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Indicators & Signals -->
            <div class="column is-4">
                <!-- Current Price & Signal -->
                <div class="box trading-card" id="signalCard">
                    <h4 class="title is-5">📊 Signal de Trading</h4>
                    <div class="content">
                        <p><strong>Prix actuel:</strong> <span class="indicator-value" id="currentPrice">--</span></p>
                        <p><strong>Signal:</strong> 
                            <span class="tag is-large" id="tradingSignal">NEUTRE</span>
                        </p>
                        <p><strong>Confiance:</strong> <span id="signalConfidence">0%</span></p>
                        
                        <hr>
                        
                        <div class="columns is-mobile">
                            <div class="column">
                                <p><strong>Stop Loss:</strong></p>
                                <span class="indicator-value has-text-danger" id="stopLoss">--</span>
                            </div>
                            <div class="column">
                                <p><strong>Take Profit:</strong></p>
                                <span class="indicator-value has-text-success" id="takeProfit">--</span>
                            </div>
                        </div>
                        
                        <p><strong>Risk/Reward:</strong> <span id="riskReward">1:1</span></p>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="box">
                    <h4 class="title is-5">📈 Indicateurs Techniques</h4>
                    <div class="content">
                        <div class="field">
                            <label class="label">ATR (Volatilité)</label>
                            <p><span id="atrValue">--</span></p>
                        </div>
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="box risk-card">
                    <h4 class="title is-5">⚡ Gestion des Risques</h4>
                    <div class="content">
                        <p><strong>Taille Position:</strong> <span id="positionSize">--</span></p>
                        <p><strong>Risque ($):</strong> <span id="riskAmount">--</span></p>
                        <p><strong>Distance SL:</strong> <span id="slDistance">--%</span></p>
                        <p><strong>Distance TP:</strong> <span id="tpDistance">--%</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Calculator Modal -->
        <div class="modal" id="riskModal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Calculateur de Risque</p>
                    <button class="delete" aria-label="close" id="closeModal"></button>
                </header>
                <section class="modal-card-body">
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Balance du compte ($)</label>
                                <div class="control">
                                    <input class="input" type="number" id="accountBalance" value="10000">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Risque par trade (%)</label>
                                <div class="control">
                                    <input class="input" type="number" id="riskPercent" value="2" step="0.1">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Prix d'entrée</label>
                                <div class="control">
                                    <input class="input" type="number" id="entryPrice" step="0.00001">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Stop Loss</label>
                                <div class="control">
                                    <input class="input" type="number" id="stopLossInput" step="0.00001">
                                </div>
                            </div>
                            
                            <button class="button is-primary" id="calculateRisk">Calculer</button>
                        </div>
                        
                        <div class="column">
                            <div id="riskResults">
                                <h5 class="title is-6">Résultats:</h5>
                                <div id="riskCalculations"></div>
                                <div id="riskScenarios"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentAsset = 'EUR/USD';
        let currentTimeframe = '1m';
        let priceChart;
        let updateInterval;
        let isConnected = true;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            setupEventListeners();
            startDataUpdates();
        });

        function setupEventListeners() {
            // Asset selector
            document.getElementById('assetSelector').addEventListener('change', function(e) {
                currentAsset = e.target.value;
                document.getElementById('chartTitle').textContent = currentAsset;
                updateData();
            });

            // Timeframe selector
            document.getElementById('timeframeSelector').addEventListener('change', function(e) {
                currentTimeframe = e.target.value;
                updateData();
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', updateData);

            // Risk calculator
            document.getElementById('riskCalcBtn').addEventListener('click', function() {
                document.getElementById('riskModal').classList.add('is-active');
                // Pre-fill with current data
                const currentPrice = parseFloat(document.getElementById('currentPrice').textContent) || 1.0;
                const sl = parseFloat(document.getElementById('stopLoss').textContent) || currentPrice * 0.98;
                
                document.getElementById('entryPrice').value = currentPrice;
                document.getElementById('stopLossInput').value = sl;
            });

            // Close modal
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('riskModal').classList.remove('is-active');
            });

            // Calculate risk
            document.getElementById('calculateRisk').addEventListener('click', calculateRiskScenarios);
        }

        function initializeChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Prix',
                            data: [],
                            borderColor: '#3273dc',
                            backgroundColor: 'rgba(50, 115, 220, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'SMA 20',
                            data: [],
                            borderColor: '#48c774',
                            borderWidth: 1,
                            fill: false
                        },
                        {
                            label: 'SMA 50',
                            data: [],
                            borderColor: '#f14668',
                            borderWidth: 1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Temps'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Prix'
                            }
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });
        }

        async function updateData() {
            try {
                // Update connection status
                updateConnectionStatus(true);
                
                // Fetch price data
                const dataResponse = await fetch(`/api/data/${encodeURIComponent(currentAsset)}`);
                const dataResult = await dataResponse.json();
                
                // Fetch analysis
                const analysisResponse = await fetch(`/api/analysis/${encodeURIComponent(currentAsset)}?timeframe=${currentTimeframe}`);
                const analysisResult = await analysisResponse.json();
                
                // Update chart
                updateChart(dataResult.data);
                
                // Update indicators and signals
                updateIndicators(analysisResult);
                
                // Update predictions
                updatePredictions(analysisResult.predictions);
                
                // Update risk management
                updateRiskManagement(analysisResult.risk_management);
                
                // Update timestamp
                const now = new Date();
                document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
                
            } catch (error) {
                console.error('Erreur lors de la mise à jour:', error);
                updateConnectionStatus(false);
            }
        }

        function updateChart(data) {
            if (!data || data.length === 0) return;
            
            const labels = data.slice(-30).map(item => {
                const date = new Date(item.datetime);
                return date.toLocaleTimeString();
            });
            
            const prices = data.slice(-30).map(item => item.close);
            const sma20 = data.slice(-30).map(item => item.sma_20);
            const sma50 = data.slice(-30).map(item => item.sma_50);
            
            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = prices;
            priceChart.data.datasets[1].data = sma20;
            priceChart.data.datasets[2].data = sma50;
            
            priceChart.update('none');
        }

        function updateIndicators(analysis) {
            // Current price
            document.getElementById('currentPrice').textContent = analysis.current_price;
            
            // Trading signal
            const signal = analysis.signal.signal;
            const signalElement = document.getElementById('tradingSignal');
            const cardElement = document.getElementById('signalCard');
            
            signalElement.textContent = signal;
            signalElement.className = `tag is-large ${getSignalClass(signal)}`;
            cardElement.className = `box trading-card ${getCardClass(signal)}`;
            
            document.getElementById('signalConfidence').textContent = analysis.signal.confidence + '%';
            document.getElementById('stopLoss').textContent = analysis.signal.sl;
            document.getElementById('takeProfit').textContent = analysis.signal.tp;
            document.getElementById('riskReward').textContent = `1:${analysis.signal.risk_reward_ratio}`;
            
            // Technical indicators
            const rsi = analysis.indicators.rsi;
            document.getElementById('rsiValue').textContent = rsi.toFixed(1);
            document.getElementById('rsiProgress').value = rsi;
            document.getElementById('rsiProgress').className = `progress ${getRSIClass(rsi)}`;
            
            document.getElementById('macdValue').textContent = analysis.indicators.macd.toFixed(5);
            document.getElementById('macdSignal').textContent = analysis.indicators.macd_signal.toFixed(5);
            document.getElementById('sma20').textContent = analysis.indicators.sma_20.toFixed(5);
            document.getElementById('sma50').textContent = analysis.indicators.sma_50.toFixed(5);
            document.getElementById('atrValue').textContent = analysis.indicators.atr.toFixed(5);
        }

        function updatePredictions(predictions) {
            const grid = document.getElementById('predictionsGrid');
            grid.innerHTML = '';
            
            Object.entries(predictions).forEach(([timeframe, prediction]) => {
                if (prediction) {
                    const card = document.createElement('div');
                    card.className = 'box';
                    
                    const variation = prediction.variation_percent;
                    const color = variation > 0 ? 'has-text-success' : 'has-text-danger';
                    const arrow = variation > 0 ? '↗️' : '↘️';
                    
                    card.innerHTML = `
                        <h6 class="title is-6">${arrow} ${timeframe.toUpperCase()}</h6>
                        <p class="indicator-value ${color}">
                            ${variation > 0 ? '+' : ''}${variation.toFixed(3)}%
                        </p>
                        <p class="is-size-7">Prix prédit: ${prediction.predicted_price}</p>
                        <p class="is-size-7">Confiance: ${prediction.confidence}</p>
                    `;
                    
                    grid.appendChild(card);
                }
            });
        }

        function updateRiskManagement(riskMgmt) {
            document.getElementById('positionSize').textContent = riskMgmt.position_size.toFixed(2);
            document.getElementById('riskAmount').textContent = 'label">RSI (14)</label>
                            <progress class="progress" id="rsiProgress" value="50" max="100">50%</progress>
                            <p class="help" id="rsiValue">50.0</p>
                        </div>
                        
                        <div class="field">
                            <label class="label">MACD</label>
                            <p><span id="macdValue">--</span> / <span id="macdSignal">--</span></p>
                        </div>
                        
                        <div class="field">
                            <label class="label">Moyennes Mobiles</label>
                            <p>SMA20: <span id="sma20">--</span></p>
                            <p>SMA50: <span id="sma50">--</span></p>
                        </div>
                        
                        <div class="field">
                            <label class=" + riskMgmt.risk_amount.toFixed(2);
            document.getElementById('slDistance').textContent = riskMgmt.sl_distance_percent.toFixed(2) + '%';
            document.getElementById('tpDistance').textContent = riskMgmt.tp_distance_percent.toFixed(2) + '%';
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                status.textContent = 'En ligne';
                isConnected = true;
            } else {
                indicator.className = 'status-indicator status-offline blinking';
                status.textContent = 'Hors ligne';
                isConnected = false;
            }
        }

        async function calculateRiskScenarios() {
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const riskPercent = parseFloat(document.getElementById('riskPercent').value);
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLossInput').value);
            
            try {
                const response = await fetch(`/api/risk-calculator?balance=${balance}&risk_percent=${riskPercent}&entry_price=${entryPrice}&stop_loss=${stopLoss}`);
                const result = await response.json();
                
                displayRiskResults(result);
            } catch (error) {
                console.error('Erreur calcul risque:', error);
            }
        }

        function displayRiskResults(result) {
            const calculationsDiv = document.getElementById('riskCalculations');
            const scenariosDiv = document.getElementById('riskScenarios');
            
            calculationsDiv.innerHTML = `
                <div class="content">
                    <p><strong>Montant risqué:</strong> ${result.calculations.risk_amount}</p>
                    <p><strong>Taille position:</strong> ${result.calculations.position_size}</p>
                    <p><strong>Distance SL:</strong> ${result.calculations.sl_distance_percent}%</p>
                    <p><strong>Perte max:</strong> ${result.calculations.max_loss}</p>
                </div>
            `;
            
            let scenariosHTML = '<h6 class="title is-6">Scénarios R:R</h6>';
            Object.entries(result.scenarios).forEach(([key, scenario]) => {
                scenariosHTML += `
                    <div class="box is-small">
                        <p><strong>R:R ${scenario.risk_reward_ratio}:1</strong></p>
                        <p>TP: ${scenario.tp_price}</p>
                        <p class="has-text-success">Profit: ${scenario.profit_potential}</p>
                    </div>
                `;
            });
            
            scenariosDiv.innerHTML = scenariosHTML;
        }

        function startDataUpdates() {
            // Initial update
            updateData();
            
            // Set up periodic updates every 10 seconds
            updateInterval = setInterval(() => {
                if (isConnected) {
                    updateData();
                }
            }, 10000);
        }

        function getSignalClass(signal) {
            switch(signal) {
                case 'ACHAT': return 'is-success';
                case 'VENTE': return 'is-danger';
                default: return 'is-light';
            }
        }

        function getCardClass(signal) {
            switch(signal) {
                case 'ACHAT': return 'signal-buy';
                case 'VENTE': return 'signal-sell';
                default: return 'signal-neutral';
            }
        }

        function getRSIClass(rsi) {
            if (rsi > 70) return 'is-danger';
            if (rsi < 30) return 'is-success';
            return 'is-info';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
